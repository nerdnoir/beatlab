#!/usr/local/bin/node

const program = require('commander')
const process = require('process')
const path = require('path')
const npmPackage = require('../package.json')
const builders = require('../lib/builders')
const fs = require('fs')
const shelljs = require('shelljs')

// BEGIN: HACK

function mix(command) {

    const loader = require('../lib/loader')
    const moduleRepo = loader.moduleRepo(command.repo)
    const moduleFullPath = path.join(moduleRepo, command.source)

    const mixer = require('../lib/mix')
    const html = builders.HELPERS.createTemplate('presenter')
    const slides = mixer(moduleFullPath)

    const deck = html({ content: slides.join('\n') })

    shelljs.mkdir('-p', command.destination)
    shelljs.cp('-r', "./vendor/reveal.js/.", command.destination)

    fs.writeFileSync(path.join(command.destination, 'index.html'), deck)
}

// END

program
  .version(npmPackage.version)

program
  .command('info')
  .description('Display default BEATLAB module path.')
  .alias('i')
  .action(function() {
    const modulePath = process.env.BEATLAB_HOME || path.join(process.cwd(), "modules")
    console.log(modulePath)
  })

program
  .command('mix <source> <destination>')
  .description('Render a track from a module path (path) to output dir (out).')
  .option('-r, --repo <repo>', "Path to a module repository.")
  .action(function(source, destination, options) {
    console.log(`Rendering module \"${source}\" to: \"${destination}\"`)

    const loader = require('../lib/loader')
    const moduleRepo = loader.moduleRepo(options.repo)
    console.log(`Resolving modules from: \"${moduleRepo}\"`)

    mix({source: source, destination: destination, repo: options.repo})
  })

program
  .command('drop <domain>', "Publish the show!")

program.parse(process.argv)